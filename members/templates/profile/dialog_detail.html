{% extends 'base/base.html' %}
{% load static %}

{% block title %}Діалог{% endblock %}

{% block content %}
<div class="dialog-page py-4">
    <div class="card dialog-card">
        <div class="card-header">
            <img
                src="{{ companion.avatar.url }}"
                alt="{{ companion.get_full_name|default:companion.username }}"
                class="dialog-header-avatar"
            />
            <div class="text-start">
                <h5 class="mb-0">{{ companion.get_full_name|default:companion.username }}</h5>
                <small class="text-muted">@{{ companion.username }}</small>
            </div>
            <a href="{% url 'profile' companion.username %}" class="btn btn-outline-secondary ms-auto">
                До профілю
            </a>
        </div>
        <div class="card-body text-start">
            <p class="text-muted small">{{ status_message }}</p>
            <ul
                class="dialog-messages"
                data-current-user-id="{{ request.user.id }}"
                data-companion-id="{{ companion.id }}"
                data-companion-username="{{ companion.username }}"
            >
                {% for day in conversation_messages %}
                    <li
                        class="dialog-date-separator"
                        data-date="{{ day.date }}"
                        aria-label="Повідомлення за {{ day.date_display }}"
                    >
                        <span>{{ day.date_display }}</span>
                    </li>
                    {% for message in day.messages %}
                        <li
                            class="dialog-message-item {% if message.is_current_user %}dialog-message-item-out{% else %}dialog-message-item-in{% endif %}"
                            data-message-id="{{ message.id }}"
                            data-sender-id="{{ message.sender_id }}"
                            data-is-current-user="{{ message.is_current_user|yesno:'true,false' }}"
                            data-is-read="{{ message.is_read|yesno:'true,false' }}"
                            data-read-display="{{ message.read_display|default:'' }}"
                        >
                            <div class="dialog-message-main {% if message.is_current_user %}dialog-message-main-out{% else %}dialog-message-main-in{% endif %}">
                                <div class="dialog-message {% if message.is_current_user %}dialog-message-out{% else %}dialog-message-in{% endif %}">
                                    <span class="dialog-message-author">{{ message.author }}</span>
                                    <span class="dialog-message-text">{{ message.text }}</span>
                                </div>
                            </div>
                            <div class="dialog-message-meta {% if message.is_current_user %}dialog-message-meta-out{% else %}dialog-message-meta-in{% endif %}">
                                <span class="dialog-message-time">{{ message.time_display }}</span>
                                {% if message.is_current_user %}
                                    <i class="bi {% if message.is_read %}bi-check-all{% else %}bi-check{% endif %}" aria-hidden="true"></i>
                                    <span class="visually-hidden">
                                        {% if message.is_read %}
                                            Повідомлення прочитано
                                        {% else %}
                                            Повідомлення надіслано
                                        {% endif %}
                                    </span>
                                {% endif %}
                            </div>
                            {% if message.is_current_user and message.is_read %}
                                <div class="dialog-message-read">прочитано {{ message.read_display }}</div>
                            {% endif %}
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
            {% if not conversation_messages %}
                <p class="text-muted mb-0">Поки що немає повідомлень у цьому діалозі.</p>
            {% endif %}
        </div>
        <div class="card-footer">
            <form class="dialog-form" method="post" action="{% url 'dialog_detail' companion.username %}">
                {% csrf_token %}
                <div class="input-group">
                    {{ message_form.text }}
                    <button class="btn btn-primary" type="submit">Надіслати</button>
                </div>
                <div class="dialog-form-errors text-danger small mt-2">
                    {% if message_form.errors %}
                        {{ message_form.errors.text|join:', ' }}
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="{% static 'members/js/dialog.js' %}"></script>
{% endblock %}
